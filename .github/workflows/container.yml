# Copyright (c) 2025 â€” 2026 Ian Torres <iantorres@outlook.com>.
# All rights reserved.

name: Build and Push Docker Image

on:
  push:
    tags:
      - '*'


env:
  REGISTRY_IMAGE: ghcr.io/strateworks/engine


jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCR_USERNAME }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Create certificates folder
        run: mkdir -p build/certificates

      - name: Decode CI_CA_CRT
        run: echo "${{ vars.CI_CA_CRT }}" | base64 --decode > build/certificates/ca.crt

      - name: Decode CI_CLIENT_CRT
        run: echo "${{ vars.CI_CLIENT_CRT }}" | base64 --decode > build/certificates/client.crt

      - name: Decode CI_CLIENT_KEY
        run: echo "${{ vars.CI_CLIENT_KEY }}" | base64 --decode > build/certificates/client.key

      - name: Decode CI_CLIENT_LISTENER_CRT
        run: echo "${{ vars.CI_CLIENT_LISTENER_CRT }}" | base64 --decode > build/certificates/client_listener.crt

      - name: Decode CI_CLIENT_LISTENER_KEY
        run: echo "${{ vars.CI_CLIENT_LISTENER_KEY }}" | base64 --decode > build/certificates/client_listener.key

      - name: Decode CI_SESSION_CRT
        run: echo "${{ vars.CI_SESSION_CRT }}" | base64 --decode > build/certificates/session.crt

      - name: Decode CI_SESSION_KEY
        run: echo "${{ vars.CI_SESSION_KEY }}" | base64 --decode > build/certificates/session.key

      - name: Decode CI_SESSION_LISTENER_CRT
        run: echo "${{ vars.CI_SESSION_LISTENER_CRT }}" | base64 --decode > build/certificates/session_listener.crt

      - name: Decode CI_SESSION_LISTENER_KEY
        run: echo "${{ vars.CI_SESSION_LISTENER_KEY }}" | base64 --decode > build/certificates/session_listener.key

      - name: Decode CI_DHPARAMS
        run: echo "${{ vars.CI_DHPARAMS }}" | base64 --decode > build/certificates/dhparams.pem

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY_IMAGE }}:${{ github.ref_name }} .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGISTRY_IMAGE }}:${{ github.ref_name }}